{% load static %}
<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CodeMentorAI</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #111317;
      --panel-2: #14171d;
      --border: #22262e;
      --text: #e8ebf0;
      --muted: #9aa3b2;
      --blue: #2f6bff;
      --bubble-user: #2f6bff;
      --bubble-ai: #1a1e24;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; color: var(--text); background: var(--bg);
      font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 0;
      min-height: 100vh;
    }
    .sidebar {
      border-right: 1px solid var(--border);
      background: var(--panel);
      display: flex; flex-direction: column;
      padding: 16px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: .2px; margin: 2px 0 14px;
    }
    .brand img { width: 28px; height: 28px; border-radius: 6px; object-fit: cover }
    .new-btn {
      display: inline-flex; align-items: center; gap: 8px;
      border: 1px solid var(--border); background: var(--panel-2);
      color: var(--text); padding: 8px 10px; border-radius: 10px;
      text-decoration: none; font-weight: 600;
    }
    .scroll { overflow: auto; flex: 1; margin-top: 14px }
    .empty { color: var(--muted); font-size: 13px; padding: 16px 4px }

    .main { display: flex; flex-direction: column; min-height: 100vh; }
    .messages {
      flex: 1; overflow: auto; padding: 24px 28px 0;
      display: grid; grid-template-columns: 1fr minmax(auto, 860px) 1fr;
      gap: 0;
    }
    .messages-inner { grid-column: 2; width: 100% }
    .bubble-row { margin: 10px 0; display: flex }
    .bubble-row.user { justify-content: flex-end }
    .bubble {
      max-width: 80%; padding: 10px 14px; border-radius: 14px;
      border: 1px solid var(--border); font-size: 15px;
      background: var(--bubble-ai);
    }
    .bubble.user { background: var(--bubble-user); border-color: transparent }
    .bubble.user .content { color: #fff }
    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--panel-2); border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 12px; color: var(--muted);
      font-weight: 600; margin: 10px 0 20px;
    }
    .input-wrap {
      border-top: 1px solid var(--border);
      padding: 14px 20px 24px;
      display: grid; grid-template-columns: 1fr minmax(auto, 860px) 1fr;
    }
    .input-inner { grid-column: 2 }
    .input-bar {
      display: grid; grid-template-columns: 1fr 96px; gap: 10px;
      background: var(--panel-2); border: 1px solid var(--border); border-radius: 16px; padding: 6px;
    }
    textarea {
      width: 100%; height: 48px; resize: none;
      background: transparent; border: 0; outline: 0; color: var(--text);
      padding: 12px 12px 12px 16px; font: inherit;
    }
    .send-btn {
      background: var(--blue); color: #fff; border: 0; border-radius: 12px;
      font-weight: 700; cursor: pointer;
    }
    .hint { color: var(--muted); font-size: 12px; margin-top: 8px; text-align: center }
    .footer { color: var(--muted); font-size: 12px; text-align: center; padding: 8px 0 18px }
    .error { color: #ff6b6b; text-align: center; margin: 6px 0 0; font-size: 13px; display:none; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <img src="{% static 'images/logo-dark.png' %}" alt="logo" />
        <span>CodeMentorAI</span>
      </div>
      <a href="{% url 'chatbot:chatbot_new' %}" class="new-btn">+ New chat</a>
      <div class="scroll">
        <div class="empty">No conversations yet</div>
      </div>
    </aside>

    <main class="main">
      <div class="messages" id="messages">
        <div class="messages-inner">
          {% if messages %}
            {% for m in messages %}
              <div class="bubble-row {{ m.role }}">
                <div class="bubble {{ m.role }}">
                  <div class="content">
                    {% if m.role == "assistant" %}
                      {{ m.content|linebreaksbr }}
                    {% else %}
                      {{ m.content|linebreaksbr }}
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="bubble-row assistant" style="justify-content:center">
              <div class="chip">
                <img src="{% static 'images/logo-light.png' %}" alt="" width="18" height="18" />
                CodeMentorAI
              </div>
            </div>
            <div class="bubble-row assistant" style="justify-content:center">
              <div class="bubble">
                <div class="content">How can I help today?</div>
              </div>
            </div>
            <div class="hint">Enter to send Â· Shift+Enter for newline</div>
          {% endif %}
        </div>
      </div>

      <div class="input-wrap">
        <div class="input-inner">
          <form id="chat-form" action="{% url 'chatbot:chatbot_ask' %}" method="post">
            {% csrf_token %}
            <div class="input-bar">
              <textarea id="message" name="message" placeholder="Message CodeMentorAI..." rows="1"></textarea>
              <button id="send-btn" type="submit" class="send-btn">Send</button>
            </div>
          </form>
          <div id="error" class="error"></div>
          <div class="footer">CodeMentorAI may produce inaccurate information about people, places, or facts.</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // --- Utilities ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    function showError(msg) {
      const el = document.getElementById('error');
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
    }
    function appendBubble(role, html) {
      const wrap = document.getElementById('messages').querySelector('.messages-inner');
      const row = document.createElement('div');
      row.className = 'bubble-row ' + role;
      const b = document.createElement('div');
      b.className = 'bubble ' + role;
      const c = document.createElement('div');
      c.className = 'content';
      c.innerHTML = html;
      b.appendChild(c);
      row.appendChild(b);
      wrap.appendChild(row);
      // scroll to bottom
      const sc = document.getElementById('messages');
      sc.scrollTop = sc.scrollHeight;
    }

    // --- Submit handler (AJAX) ---
    const form = document.getElementById('chat-form');
    const textarea = document.getElementById('message');
    const sendBtn = document.getElementById('send-btn');

    // Auto-resize textarea
    function autoresize() {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(160, textarea.scrollHeight) + 'px';
    }
    textarea.addEventListener('input', autoresize);
    autoresize();

    // Enter to send (Shift+Enter newline)
    textarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.requestSubmit();
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = (textarea.value || '').trim();
      if (!msg) return;

      appendBubble('user', msg.replace(/\n/g, '<br>'));
      textarea.value = '';
      autoresize();
      if (sendBtn) sendBtn.disabled = true;

      try {
        const res = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken') || ''
          },
          body: JSON.stringify({ message: msg })
        });

        if (!res.ok) {
          const text = await res.text();
          showError(`Error ${res.status}: ${text.slice(0, 200)}`);
          appendBubble('assistant', 'Sorry, I hit an error contacting the model.');
          return;
        }

        const data = await res.json();
        appendBubble('assistant', data.reply_html || 'OK');
      } catch (err) {
        showError(err?.message || 'Network error');
        appendBubble('assistant', 'Network error. Please try again.');
      } finally {
        if (sendBtn) sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
