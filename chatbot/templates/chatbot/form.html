{% load static %}
<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CodeMentorAI</title>
  <style>
    :root {
      --bg: #0b0c0f; --panel:#111317; --panel-2:#14171d; --border:#22262e;
      --text:#e8ebf0; --muted:#9aa3b2; --blue:#2f6bff; --bubble-user:#2f6bff; --bubble-ai:#1a1e24;
    }
    /* Light theme overrides */
    [data-theme="light"] {
      --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f3f5f9; --border:#dfe3ea;
      --text:#0e1116; --muted:#5b6574; --blue:#2f6bff; --bubble-user:#2f6bff; --bubble-ai:#ffffff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);background:var(--bg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .layout{display:grid;grid-template-columns:300px 1fr;min-height:100vh}
    .sidebar{border-right:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;padding:16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;margin:2px 0 8px}
    .brand img{width:28px;height:28px;border-radius:6px;object-fit:cover}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .icon-btn{border:1px solid var(--border);background:var(--panel-2);color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer}
    .new-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:8px 10px;border-radius:10px;text-decoration:none;font-weight:600;margin-top:8px}
    .scroll{overflow:auto;flex:1;margin-top:14px}
    .conv{display:block;color:inherit;text-decoration:none;border:1px solid var(--border);background:var(--panel-2);padding:8px 10px;border-radius:10px;margin:6px 0}
    .conv.active{outline:2px solid var(--blue);outline-offset:0}
    .empty-note{color:var(--muted);font-size:13px;padding:10px 4px}

    .main{display:flex;flex-direction:column;min-height:100vh}
    .messages{flex:1;overflow:auto;padding:24px 28px 0;display:grid;grid-template-columns:1fr minmax(auto,860px) 1fr}
    .messages-inner{grid-column:2;width:100%}
    .bubble-row{margin:10px 0;display:flex}
    .bubble-row.user{justify-content:flex-end}
    .bubble{max-width:80%;padding:10px 14px;border-radius:14px;border:1px solid var(--border);font-size:15px;background:var(--bubble-ai)}
    .bubble.user{background:var(--bubble-user);border-color:transparent}
    .bubble.user .content{color:#fff}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel-2);border:1px solid var(--border);padding:6px 10px;border-radius:12px;color:var(--muted);font-weight:600;margin:10px 0 20px}
    .center-wrap{display:grid;place-items:center;padding:60px 20px}
    .center-card{width:100%;max-width:720px;background:var(--panel-2);border:1px solid var(--border);border-radius:16px;padding:16px}
    .center-title{font-size:18px;font-weight:700;margin-bottom:10px;color:var(--muted)}
    .input-wrap{border-top:1px solid var(--border);padding:14px 20px 24px;display:grid;grid-template-columns:1fr minmax(auto,860px) 1fr}
    .input-inner{grid-column:2}
    .input-bar{display:grid;grid-template-columns:1fr 96px;gap:10px;background:var(--panel-2);border:1px solid var(--border);border-radius:16px;padding:6px}
    textarea{width:100%;height:48px;resize:none;background:transparent;border:0;outline:0;color:var(--text);padding:12px 12px 12px 16px;font:inherit}
    .send-btn{background:var(--blue);color:#fff;border:0;border-radius:12px;font-weight:700;cursor:pointer}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;text-align:center}
    .footer{color:var(--muted);font-size:12px;text-align:center;padding:8px 0 18px}
    .error{color:#ff6b6b;text-align:center;margin:6px 0 0;font-size:13px;display:none}
  </style>
  <script>
    // Persist theme in localStorage
    (function(){
      const saved = localStorage.getItem("cm-theme");
      if (saved) document.documentElement.dataset.theme = saved;
    })();
  </script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="row">
        <div class="brand">
          <img src="{% static 'images/logo-dark.png' %}" alt="logo" />
          <span>CodeMentorAI</span>
        </div>
        <button class="icon-btn" id="theme-toggle" title="Toggle theme">🌙</button>
      </div>

      <a href="{% url 'chatbot:chatbot_new' %}" class="new-btn">+ New chat</a>

      <div class="scroll">
        {% if conversations %}
          {% for c in conversations %}
            <a class="conv {% if c.id == current_id %}active{% endif %}"
               href="{% url 'chatbot:chatbot_chat' c.id %}">
               {{ c.title }}
            </a>
          {% endfor %}
        {% else %}
          <div class="empty-note">No conversations yet</div>
        {% endif %}
      </div>
    </aside>

    <main class="main">
      <div class="messages" id="messages">
        <div class="messages-inner">
          {% if messages %}
            {% for m in messages %}
              <div class="bubble-row {{ m.role }}">
                <div class="bubble {{ m.role }}"><div class="content">{{ m.content|linebreaksbr }}</div></div>
              </div>
            {% endfor %}
          {% else %}
            <!-- Centered first input on empty state -->
            <div class="center-wrap">
              <div class="center-card">
                <div class="center-title">How can I help?</div>
                <form data-chat-form action="{% url 'chatbot:chatbot_ask' %}" method="post">
                  {% csrf_token %}
                  <div class="input-bar">
                    <textarea rows="1" placeholder="Ask anything…" data-chat-input></textarea>
                    <button type="submit" class="send-btn" data-chat-send>Send</button>
                  </div>
                </form>
                <div class="hint">Enter to send · Shift+Enter for newline</div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Always-present bottom input -->
      <div class="input-wrap">
        <div class="input-inner">
          <form data-chat-form action="{% url 'chatbot:chatbot_ask' %}" method="post">
            {% csrf_token %}
            <div class="input-bar">
              <textarea rows="1" placeholder="Message CodeMentorAI..." data-chat-input></textarea>
              <button type="submit" class="send-btn" data-chat-send>Send</button>
            </div>
          </form>
          <div id="error" class="error"></div>
          <div class="footer">CodeMentorAI may produce inaccurate information about people, places, or facts.</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Theme toggle
    document.getElementById('theme-toggle')?.addEventListener('click', () => {
      const root = document.documentElement;
      const next = root.dataset.theme === 'light' ? 'dark' : 'light';
      root.dataset.theme = next;
      localStorage.setItem('cm-theme', next);
      // swap icon
      document.getElementById('theme-toggle').textContent = next === 'light' ? '☀️' : '🌙';
    });
    // set initial icon
    (function(){
      const btn = document.getElementById('theme-toggle');
      if (!btn) return;
      btn.textContent = (document.documentElement.dataset.theme === 'light') ? '☀️' : '🌙';
    })();

    // Chat wiring (layout-agnostic: works for both forms)
    function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);return v.length===2?v.pop().split(';').shift():null;}
    function showError(msg){const el=document.getElementById('error');if(el){el.textContent=msg;el.style.display='block';}}
    function appendBubble(role, html){
      const wrap=document.querySelector('#messages .messages-inner'); if(!wrap) return;
      const row=document.createElement('div'); row.className='bubble-row '+role;
      const b=document.createElement('div'); b.className='bubble '+role;
      const c=document.createElement('div'); c.className='content'; c.innerHTML=html;
      b.appendChild(c); row.appendChild(b); wrap.appendChild(row);
      const sc=document.getElementById('messages'); sc.scrollTop=sc.scrollHeight;
    }
    function attachForm(form){
      const textarea=form.querySelector('[data-chat-input]');
      const send=form.querySelector('[data-chat-send]');
      if(!textarea) return;
      // autoresize
      function autoresize(){ textarea.style.height='auto'; textarea.style.height=Math.min(160, textarea.scrollHeight)+'px'; }
      textarea.addEventListener('input', autoresize); autoresize();
      textarea.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); } });
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg=(textarea.value||'').trim(); if(!msg) return;
        appendBubble('user', msg.replace(/\n/g,'<br>')); textarea.value=''; autoresize(); if(send) send.disabled=true;
        try{
          const res=await fetch(form.action,{method:'POST',headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken')||''},body:JSON.stringify({message:msg})});
          if(!res.ok){const t=await res.text(); showError(`Error ${res.status}: ${t.slice(0,200)}`); appendBubble('assistant','Sorry, I hit an error contacting the model.'); return;}
          const data=await res.json(); appendBubble('assistant', data.reply_html || 'OK');
        }catch(err){ showError(err?.message||'Network error'); appendBubble('assistant','Network error. Please try again.'); }
        finally{ if(send) send.disabled=false; }
      });
    }
    document.querySelectorAll('form[data-chat-form]').forEach(attachForm);
  </script>
</body>
</html>
